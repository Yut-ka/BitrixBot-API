# Бот-сборщик диалогов Битрикс24

Этот проект представляет собой Python-приложение для сбора и хранения диалогов из Открытых линий Битрикс24. Его основная задача — выступать в роли "бота-регистратора", который автоматически подключается ко всем новым диалогам, сохраняет их в локальную базу данных SQLite, а затем немедленно передает диалог оператору.

Это решает проблему API Битрикс24, при которой невозможно получить доступ к диалогам, в которых не участвует администратор или приложение.

## Архитектура

- **`main.py`**: Основное Flask-приложение, которое обрабатывает вебхуки от Битрикс24 и предоставляет API для доступа к данным.
- **`config.py`**: Файл для хранения `CLIENT_ID` и `CLIENT_SECRET` вашего приложения. **(Конфигурация бота)**
- **`auth.json`**: Файл, в который бот автоматически сохраняет токен доступа после установки. **Не трогать и не добавлять в Git.**
- **`dialogs.db`**: Файл базы данных SQLite, где хранятся все диалоги, участники и сообщения. **Не добавлять в Git.**
- **`setup.sh`**: Интерактивный скрипт для автоматической настройки сервера и развертывания бота.



## Установка

1.  **Зарегистироваться на DuckDNS.org**
    Получить домен и токен для интеграции

2.  **Создать папку по пути /var/www/html/python_bot и распаковать туда архив**

3.  **Запустить установочный скрипт и следвать инструкциям**
    Скрипт запросит у вас домен и токен DuckDNS, а затем автоматически настроит сервер.
    ```
    chmod +x setup.sh
    sudo ./setup.sh
    ```

4. **(Ошибки) На некоторых серверах nginx может не созвать пользователя www-data**
    Запустите команду:
    ```
    sudo groupadd --system www-data
    sudo useradd --system --gid www-data --shell /usr/sbin/nologin --home /var/www www-data
    ```
    Потом еще раз запустите скрипт установки (Пункт 3)

5. **(Ошибки) Если произошла ошибка "The virtual environment was not created successfully because ensurepip is not available. On Debian/Ubuntu systems, you need to install the python3-venv package using the following command"**
    Запустите команду:
    ```
    sudo apt install python3.12-venv
    ```
    И верннитесь на Пункт 3. ## Установка
    



## Если начальный сервер (нет папки /var/www)
    Запустите команды:
    ```
    sudo apt update
    sudo apt install -y nginx php-fpm php-mysql mariadb-server unzip
    sudo mkdir -p /var/www/html
    ```
    Далее Переходите на Пункт 2. ## Установка


## Настройка приложения в Битрикс24


1.  **Создание приложения:**
    - В вашем портале Битрикс24 перейдите в раздел "Приложения" -> "Разработчикам".
    - Нажмите "Добавить приложение" -> "Другое" -> "Локальное приложение".

2.  **Настройка путей:**
    - **Путь обработчика:** Укажите ваш публичный HTTPS-адрес, например: `http://your-domain.duckdns.org/python_bot/`  Используем http протокол
    - **Путь для первоначальной установки:** указываем такой же

3.  **Настройка прав (Scopes):**
    Это критически важный пункт. Выдайте приложению следующие разрешения:
    - **`imopenlines`** (Открытые линии) - для работы с чатами открытых линий.
    - **`imbot`** (Создание и управление Чат-ботами) - для регистрации бота и получения событий.
    - **`user`** (Пользователи) - для получения информации об участниках диалога (имена, роли).

4. **Добавьте бота по имени "Python Interceptor Bot" в вашу открытую линию**

5. **Работа бота в файле базы данных - /var/www/html/python_bot/dialogs.db**

6.  **Переустановка:**
    - **ВАЖНО:** Каждый раз, когда вы меняете права (scopes) приложения, его необходимо **"Переустановить"**, чтобы новые права применились к токену доступа.
    - **ОШИБКИ:** Для каждого домена и токена DuckDNS создается новое подключение, поэтому если после установки интеграции в кабинете - в папке не появился /var/www/html/python_bot/auth.json,
    то необходимо изменить файл main.py, а именно 17 строку - значение API_SECRET_TOKEN - написать другой токен. И затем переустановить интеграцию

