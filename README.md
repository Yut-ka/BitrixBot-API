# Bitrix24 Bot-API (–º—É–ª—å—Ç–∏-–∏–Ω—Å—Ç–∞–Ω—Å, HTTP-only)

Python/Flask –±–æ—Ç –¥–ª—è **–û—Ç–∫—Ä—ã—Ç—ã—Ö –ª–∏–Ω–∏–π** Bitrix24. –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ SQLite –∏ —Å—Ä–∞–∑—É –ø–µ—Ä–µ–¥–∞—ë—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤** –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ (–¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ä—Ç–∞–ª–æ–≤ –ë24), —Ä–∞–±–æ—Ç—É –ø–æ **HTTP** (–±–µ–∑ TLS) –∏ –¥–æ–º–µ–Ω—ã **DuckDNS** –∏–ª–∏ **—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ** (–≤–∫–ª—é—á–∞—è **–∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ** / IDN).

> –í–∞–∂–Ω–æ: URL –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ Bitrix24 **–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞** `/python_bot/` (—Å–æ —Å–ª—ç—à–µ–º).

---

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- üéõÔ∏è **–ú—É–ª—å—Ç–∏-–∏–Ω—Å—Ç–∞–Ω—Å**: –∫–∞–∂–¥—ã–π –∏–Ω—Å—Ç–∞–Ω—Å ‚Äî —Å–≤–æ–π –ø–æ—Ä—Ç, —Å–≤–æ—è –ø–∞–ø–∫–∞, —Å–≤–æ—è –ë–î –∏ `auth.json`.
- üåê **–î–æ–º–µ–Ω –ª—é–±–æ–π**: DuckDNS –∏–ª–∏ —Å–≤–æ–π FQDN (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ IDN ‚Üí Punycode).
- üîå **Nginx reverse-proxy** —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `/<instance>/‚Ä¶`.
- üß© **–ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î**: —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –∏ `ONAPPINSTALL` —Å–æ–∑–¥–∞—é—Ç —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –ë–î –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.
- üîê **–ê–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω** –≤ ENV-—Ñ–∞–π–ª–µ per-instance: `API_SECRET_TOKEN`.
- üß∞ **–£—Ç–∏–ª–∏—Ç–∞ botctl**: `on/off/restart/status/enable/disable/purge`.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
/var/www/b24bots/<instance>/
  ‚îú‚îÄ .venv/                # –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python
  ‚îú‚îÄ main.py               # Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–≤–µ–±—Ö—É–∫–∏ + API)
  ‚îú‚îÄ dialogs.db            # SQLite –±–∞–∑–∞ –¥–∏–∞–ª–æ–≥–æ–≤
  ‚îú‚îÄ auth.json             # —Ç–æ–∫–µ–Ω—ã/—ç–Ω–¥–æ–∏–Ω—Ç—ã –ë24 (—Å–æ–∑–¥–∞—ë—Ç—Å—è ONAPPINSTALL)
  ‚îú‚îÄ bot.log               # –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  ‚îú‚îÄ ENABLED / DISABLED    # —Ñ–ª–∞–≥–∏ –≤–∫–ª—é—á–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  ‚îî‚îÄ ‚Ä¶
/etc/b24bot/
  ‚îú‚îÄ ports.map             # —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ <instance>:<port>
  ‚îî‚îÄ env/<instance>.env    # API_SECRET_TOKEN –¥–ª—è –∏–Ω—Å—Ç–∞–Ω—Å–∞
/etc/nginx/
  ‚îú‚îÄ sites-{available,enabled}/b24bots-<domain>   # vhost –Ω–∞ –¥–æ–º–µ–Ω
  ‚îî‚îÄ b24bots.d/<domain>/<instance>.conf           # –ª–æ–∫–∞—Ü–∏–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞
```

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
```bash
chmod +x setup_multi.sh
sudo ./setup_multi.sh
```
–ú–∞—Å—Ç–µ—Ä —Å–ø—Ä–æ—Å–∏—Ç:
- `instance` ‚Äî –∏–º—è –≤ `[a-z0-9-]`, –Ω–∞–ø—Ä. `client1`;
- –¥–æ–º–µ–Ω: DuckDNS (—Å—É–±–¥–æ–º–µ–Ω + —Ç–æ–∫–µ–Ω) **–∏–ª–∏** —Å–≤–æ–π FQDN (IDN –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è);
- `API_SECRET_TOKEN` ‚Äî –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

–ò—Ç–æ–≥–æ–≤—ã–π URL:
```
http://<–¥–æ–º–µ–Ω>/<instance>/python_bot/
```

### 2) –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Bitrix24
1. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º ‚Üí –î–æ–±–∞–≤–∏—Ç—å ‚Üí –î—Ä—É–≥–æ–µ ‚Üí –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**.  
2. **–ü—É—Ç–∏** (–æ–±–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ):  
   `http://<–¥–æ–º–µ–Ω>/<instance>/python_bot/`  **(—Å–æ —Å–ª—ç—à–µ–º!)**
3. **–ü—Ä–∞–≤–∞** (scopes): `imbot`, `imopenlines`, `user`.
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è `ONAPPINSTALL`; —Å–æ–∑–¥–∞—Å—Ç—Å—è **–ë–î** –∏ `auth.json`.

---

## URL‚Äô—ã

- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–æ—Ç–∞** (Bitrix24):  
  `http://<–¥–æ–º–µ–Ω>/<instance>/python_bot/`
- **–í–∞—à API**:
  - –î–∏–∞–ª–æ–≥–∏ (GET):  
    `http://<–¥–æ–º–µ–Ω>/<instance>/api/dialogs`
  - –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ä–æ–±–Ω–æ (GET):  
    `http://<–¥–æ–º–µ–Ω>/<instance>/api/dialogs/<chat_id>`
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (GET):  
    `http://<–¥–æ–º–µ–Ω>/<instance>/api/users`
- **–ê–¥–º–∏–Ω-—ç–Ω–¥–ø–æ–π–Ω—Ç—ã** (–ø–æ —Ç–æ–∫–µ–Ω—É —á–µ—Ä–µ–∑ `?token=` –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-API-Token`):
  - –í–∫–ª—é—á–∏—Ç—å:  `POST http://<–¥–æ–º–µ–Ω>/<instance>/api/admin/enable?token=‚Ä¶`
  - –í—ã–∫–ª—é—á–∏—Ç—å: `POST http://<–¥–æ–º–µ–Ω>/<instance>/api/admin/disable?token=‚Ä¶`
  - –°—Ç–∞—Ç—É—Å:    `GET  http://<–¥–æ–º–µ–Ω>/<instance>/api/admin/status?token=‚Ä¶`
  - (–æ–ø—Ü.) –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î: `POST /api/admin/reinit_db?token=‚Ä¶` ‚Äî –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –∫–æ–¥

### –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ API
```bash
# –≤–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞
curl -X POST "http://<–¥–æ–º–µ–Ω>/<instance>/api/admin/enable?token=<API_SECRET_TOKEN>"
```

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏

`/usr/local/bin/botctl`:
```bash
sudo botctl <instance> on        # –≤–∫–ª—é—á–∏—Ç—å (—Å–æ–∑–¥–∞—Ç—å ENABLED, –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å)
sudo botctl <instance> off       # –≤—ã–∫–ª—é—á–∏—Ç—å (–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å, —Å–æ–∑–¥–∞—Ç—å DISABLED)
sudo botctl <instance> status    # —Å—Ç–∞—Ç—É—Å systemd + runtime-—Ñ–ª–∞–≥
sudo botctl <instance> restart   # –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo botctl <instance> enable    # systemd enable
sudo botctl <instance> disable   # systemd disable
sudo botctl <instance> purge     # –ü–û–õ–ù–û–ï —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å–∞(–ë–æ—Ç–∞-API)
```
`purge` —É–¥–∞–ª—è–µ—Ç: systemd-—é–Ω–∏—Ç, `/var/www/b24bots/<instance>`, –∑–∞–ø–∏—Å—å –≤ `ports.map`, env-—Ñ–∞–π–ª, nginx-—Å–Ω–∏–ø–ø–µ—Ç—ã (–∏ vhost –¥–æ–º–µ–Ω–∞, –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç), –∑–∞—Ç–µ–º –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç Nginx.

---

## –°–µ–∫—Ä–µ—Ç—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–ê–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω** —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤:  
  `/etc/b24bot/env/<instance>.env` (—Å—Ç—Ä–æ–∫–∞ `API_SECRET_TOKEN=...`).
- –°–º–µ–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω:
  ```bash
  sudo nano /etc/b24bot/env/<instance>.env
  sudo systemctl restart gunicorn-b24bot-<instance>
  ```
- –í `main.py` —Ç–æ–∫–µ–Ω —á–∏—Ç–∞–µ—Ç—Å—è —Ç–∞–∫:  
  `API_SECRET_TOKEN = os.environ.get('API_SECRET_TOKEN', '...')`

> –≠—Ç–æ **–Ω–µ** `application_token` Bitrix24. –ï–≥–æ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –ë24 –Ω–∞ `ONAPPINSTALL`, –∏ –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `auth.json`.

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞—ë—Ç—Å—è:
1) —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–º (`main.init_db()`);
2) –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `ONAPPINSTALL` (`init_db()` –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω).

–ï—Å–ª–∏ —É–¥–∞–ª–∏—Ç—å `dialogs.db`, –æ–Ω–∞ —Å–æ–∑–¥–∞—Å—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `ensure_db_exists()`).

---

## –õ–æ–≥–∏ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
# –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
tail -f /var/www/b24bots/<instance>/bot.log

# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
systemctl status gunicorn-b24bot-<instance>
journalctl -u gunicorn-b24bot-<instance> -n 200 --no-pager

# Nginx
sudo nginx -t && sudo systemctl reload nginx
sudo tail -n 100 /var/log/nginx/access.log
sudo tail -n 200 /var/log/nginx/error.log
```

–ï—Å–ª–∏ –¥–æ–º–µ–Ω –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–π ‚Äî –≤ Nginx –æ–Ω –±—É–¥–µ—Ç –∫–∞–∫ Punycode, –Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ¬´—á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π¬ª –≤–∏–¥.

---

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
```bash
cd /var/www/b24bots/<instance>
sudo -u www-data git pull          # –µ—Å–ª–∏ –∏–Ω—Å—Ç–∞–Ω—Å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –∏–∑ git
sudo systemctl restart gunicorn-b24bot-<instance>
```

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Ubuntu/Debian —Å `nginx`, `python3`, `python3-venv`, `git`, `sqlite3`, `curl`
- –û—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç `80/tcp` (–µ—Å–ª–∏ UFW –≤–∫–ª—é—á—ë–Ω):
  ```bash
  sudo ufw allow 80/tcp
  ```

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –Ω—é–∞–Ω—Å—ã
- –í Bitrix24 **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** —Å—Ç–∞–≤—å—Ç–µ —Å–ª—ç—à –≤ –∫–æ–Ω—Ü–µ –ø—É—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞: `/python_bot/` ‚Äî –∏–Ω–∞—á–µ –±—É–¥–µ—Ç `404`.
- –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –Ω–∞ –æ–¥–∏–Ω –¥–æ–º–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å—ã: `/client1/‚Ä¶`, `/client2/‚Ä¶`.
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç `default_server` –≤ Nginx —Ä–µ—à–∞–µ—Ç—Å—è –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ `b24bots`/`default`.
- –î–ª—è DuckDNS —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—ë—Ç `cron` –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ IP.

---

## –õ–∏—Ü–µ–Ω–∑–∏—è
MIT (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–∞—á–µ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏).
